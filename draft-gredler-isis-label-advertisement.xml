<?xml version="1.0" encoding="US-ASCII"?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd">
<?rfc toc="yes"?>
<?rfc tocompact="yes"?>
<?rfc tocdepth="4"?>
<?rfc tocindent="yes"?>
<?rfc symrefs="yes"?>
<?rfc sortrefs="yes" ?>
<?rfc comments="yes"?>
<?rfc inline="yes"?>
<?rfc compact="yes" ?>
<?rfc subcompact="no" ?>
<rfc category="std" docName="draft-gredler-isis-label-advertisement-00" ipr="trust200902">

  <!-- ***** FRONT MATTER ***** -->

  <front>
    <title>Advertising MPLS labels in IS-IS</title>

    <!-- add 'role="editor"' below for the editors if appropriate -->

    <author fullname="Hannes Gredler" initials="H." surname="Gredler">
      <organization>Juniper Networks, Inc.</organization>
      <address>
	<postal>
	  <street>1194 N. Mathilda Ave.</street>
	  <city>Sunnyvale</city>
	  <region>CA</region>
	  <code>94089</code>
	  <country>US</country>
	</postal>
	<email>hannes@juniper.net</email>
      </address>
    </author>

    <date day="29" month="March" year="2013"/>

    <area>Routing</area>

    <workgroup>IS-IS for IP Internets Working Group</workgroup>

    <keyword>MPLS</keyword>
    <keyword>IGP</keyword>
    <keyword>IS-IS</keyword>
    <keyword>Label advertisement</keyword>

    <abstract>
      <t>Historically intra-AS MPLS label distribution was driven by
      protocols like LDP and RSVP. Both of those protocols are session
      oriented. In order to obtain a particular routers label binding for a
      given destination FEC one needs to have first an established session
      with that node.</t>

      <t><xref target="I-D.gredler-rtgwg-igp-label-advertisement">
	Advertising MPLS labels in IGPs advertisement</xref>
	describes several use cases where utilizing the flooding machinery
	of link-state protocols for MPLS label distribution makes sense</t>

	<t>This document describes the protocol extension to distribute
	MPLS labels by the IS-IS protocol.</t>
    </abstract>

    <note title="Requirements Language">
      <t>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
      "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
      document are to be interpreted as described in <xref
      target="RFC2119">RFC 2119</xref>.</t>
    </note>
  </front>

  <middle>
    <section title="Introduction">
      <t>MPLS label allocations are predominantly distributed by using
      the LDP <xref target="RFC5036"/>, RSVP <xref target="RFC5151"/> or
      labeled BGP <xref target="RFC3107"/> protocol. All of those protocols
      have in common that they are session oriented, which means that in
      order to learn the Label Information database of a particular router
      one needs to have a direct control-plane session using the given
      protocol.</t>

      <t>There are a couple of
      <xref target="I-D.gredler-rtgwg-igp-label-advertisement">use cases</xref>
      where the consumer of a MPLS label allocation may not be adjacent to the router
      having allocated the label. Bringing up an explicit session using
      existing label distribution protocols between the non-adjacent label
      allocator and the label consumer is the existing remedy for this
      dilemma.</t>

      <t> Depending on the application, retrieval and setup of
      forwarding state of such >1 hop label allocations may only be
      transient.  As such configuring and un-configuring the explicit session
      is an operational burden and therefore should be avoided.</t>

      <t>This document describes a single IS-IS protocol extension which allows
      routers to advertise MPLS labels, its inter-area distribution as well
      as how to advertise MPLS labels sourced from outside the IGP domain. 
      </t> 

    </section>

  <section title="Motivation, Rationale and Applicability">
    <t>Distributing MPLS labels using IS-IS has been described in
    <xref target="I-D.previdi-filsfils-isis-segment-routing"> Segment
    Routing</xref>. The authors propose to re-use the IS-Reach TLVs (22,
    23, 222) and Extended IP Prefix TLVs (135, 236) for carrying the label
    information.  While retrofitting existing protocol machinery for new
    purposes is generally a good thing, <xref
    target="I-D.previdi-filsfils-isis-segment-routing">Segment
    Routing</xref> falls short of adressing some use-cases defined in
    <xref target="I-D.gredler-rtgwg-igp-label-advertisement"/>.
    </t>

    <t>The dominant issue of re-using IS-Reach TLVs and the extended IP Prefix TLVs is that
    both family of TLVs have exisiting protocol semantics, which might not be applicable
    to advertising MPLS labels in a generic fashion. These are specifically:</t>

    <t><list style="symbols">
      <t>Bi-directionality semantics</t>
      <t>IP path semantics</t>
    </list>
    </t>

    <section title="Issue: Bi-directionality semantics">
      <t>
      'Bi-directionality semantics', affects the complexity around advertisement of unidirectional LSPs.
      Label advertisement of per-link labels or <xref
      target="I-D.previdi-filsfils-isis-segment-routing">'Adj-SIDs'</xref>
      is done using IS-reach TLVs. Usually implementations need to have
      an adjacency in 'Up' state prior to advertising this adjacency
      as IS-reach TLV in its Link State PDUs (LSPs).
      In order to advertise a per-link LSP an implementation first needs to have
      an adjacency, which only transitions to 'Up' state after passing the 3-way
      check. This implies bi-directionality. If an implementation wants to advertise
      per-link LSPs to e.g. outside the IGP domain then it would need
      to fake-up an adjacency. Bending existing IGP Adjacency code to support
      such cases defeats the purpose of re-using existing functionality as there is
      not much common functionality to be shared.
      </t>
    </section>

    <section title="Issue: IP path semantics">
      <t>
	LSPs pointing to a Node are advertised as <xref
	target="I-D.previdi-filsfils-isis-segment-routing">'Node-SIDs'</xref>
	using the family of extended IP Reach TLVs. That means that in order
	to advertise a LSP, one is inheriting the semantics of advertising an
	IP path. Consider router A has got exisiting LSPs to its entire one-hop
	neighborhood and is re-advertising those LSPs using IP reachability semantics.
	Now we have two exact matching IP advertisements. One from the owning router
	(router B) which advertises its stable transport loopback address and another one
	from router A re-advertising a LSP path to router B. Existing routing software
	may get confused now as the 'stable transport' address shows up from multiple places
	in the network and more worse the IP forwarding path for control-plane protocols may get
	mingled with the MPLS dataplane. 
      </t>
    </section>

    <section title="Motivation">
    <t>MPLS label advertisement for IGPs is a new forwarding paradim which hardly can be expressed
    using existing IGP protocol machinery.
    This document describes protocol extensions which allows MPLS label advertisement
    in IS-IS by just re-using the flooding machinery and thereby not
    inheriting any unwanted, unrelated semantics from existing protocol machinery.</t>
    </section>

  </section>

    <section title="MPLS label TLV">
      <t>The MPLS Label TLV may be originated by any <xref target="RFC5305">Traffic Engineering</xref>
      capable router in an IS-IS domain. A router may advertise MPLS labels along with so called 'ERO'
      path segments describing the label switched path. Since ERO style path notation allows to
      express pointers to link and node IP adresses any label switched path, sourced by any protocol
      can be described.
      </t>

      <!-- FIXME add a node about sequential advertisements of TLVs -->

      <t>The MPLS Label TLV has type 149 and contains a data structure
      consisting of:</t>

        <figure anchor="MPLS-TLV-figure" title="MPLS TLV format">
          <artwork>
   0                   1                   2                   3
   0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  |U|W|P|    Reserved     |            MPLS Label                 |
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  </artwork>
        </figure>

      <t><list style="symbols">
	  <t>12 bits of flags, consisting of:
	  <list style="symbols">
	    <t>1 bit of up/down information (U bit)</t>
	    <t>1 bit of Local/Domain wide information (W bit)</t>
	    <t>1 bit of PHP information (P bit)</t>
	    <t>9 bits are Reserved for future use</t>
	  </list></t>
	  <t>20 bits of MPLS label information</t>
	  <t>0-251 octets of sub-TLVs, where each sub-TLV consists of a
	  sequence of:
	  <list style="symbols">
	    <t>1 octet of sub-TLV type</t>
	    <t>1 octet of length of the value field of the sub-TLV</t>
	    <t>0-249 octets of value</t>
	  </list></t>
	</list></t>	

	<section title="Flags">
	  <t>Flags
	  <list style="hanging">
	    <t>Up/Down Bit: A router may flood MPLS label information across level boundaries.
	    In order to prevent flooding loops, a router will Set the Up/Down (U-Bit)
	    when propagating from Level 2 down to Level 1. This is done as per the
	    procedures for IP Prefixes lined out <xref target="RFC5302">RFC 5302</xref>.
	    </t>

	    <t>Router Local/ Domain Wide Bit: This bit gets set if domain wide labels are used.
	    This bit is unset if the Router isadvertising from its local label space.
	    Domain wide labels are defined <xref target="I-D.previdi-filsfils-isis-segment-routing"/>
	    </t>

	    <t>UHP / PHP Bit: This bit may only be set for Domain Wide labels.
	    Domain wide labels are defined <xref target="I-D.previdi-filsfils-isis-segment-routing"/>
	    If the P Bit is set then the Originator of this Domain-Wide label requires to
	    POP of the top label by penultimate routers.
	    <!-- FIXME add link to PHP behaviour -->
	    </t>
	  </list></t>
	</section>

	<section title="subTLV support">
	  <t>
	    An originating router MAY want to attach one or more subTLVs to the MPLS label TLV.
	    SubTLVs presence is inferred from the length of the MPLS Label TLV.
	    If the MPLS Label TLV Length field is > 4 octets then one or more subTLVs are present. 
	  </t>
	</section>

	<section title="IPv4 Prefix ERO subTLV">
	  <t>The IPv4 ERO subTLV (Type 1) describes a path segment using IPv4 Prefix style of encoding.
	  Its appearance and semantics have been borrowed from <xref target="RFC3209">
	  Section 4.3.3.2</xref>.
	  </t>

	  <t>The 'Prefix Length' field contains the length of the prefix in bits.
	  Only the most significant octets of the prefix are encoded. I.e. 1
	  octet for prefix length 1 up to 8, 2 octets for prefix length 9 to
	  16, 3 octets for prefix length 17 up to 24 and 4 octets for prefix
	  length 25 up to 32, etc.</t>

        <figure anchor="IPv4-Prefix-ERO-subTLV-figure" title="IPv4 Prefix ERO subTLV format">
          <artwork>
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |L|    Type     |     Length    | Prefix Length |  IPv4 Prefix  |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   | IPv4 Prefix  (continued, variable-length      |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

  </artwork> 
        </figure>
	</section> <!-- end IPv4 Prefix ERO subtLV -->

	<section title="IPv6 Prefix ERO subTLV">
	  <t>The IPv6 ERO subTLV (Type 2) describes a path segment using IPv6 Prefix style of encoding.
	  Its appearance and semantics have been borrowed from <xref target="RFC3209">
	  Section 4.3.3.3</xref>.
	  </t>

	  <t>The 'Prefix Length' field contains the length of the prefix in bits.
	  Only the most significant octets of the prefix are encoded. I.e. 1
	  octet for prefix length 1 up to 8, 2 octets for prefix length 9 to
	  16, 3 octets for prefix length 17 up to 24 and 4 octets for prefix
	  length 25 up to 32, ...., 16 octets for prefix length 113 up to 128.
	  </t>

        <figure anchor="IPv6-Prefix-ERO-subTLV-figure" title="IPv6 Prefix ERO subTLV format">
          <artwork>
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |L|    Type     |     Length    | Prefix Length | IPv6 Prefix   |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   | IPv6 Prefix (continued)                                       |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   | IPv6 Prefix (continued)                                       |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   | IPv6 Prefix (continued)                                       |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   | IPv6 Prefix (continued, variable length)      |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

  </artwork>
        </figure>
	</section> <!-- end IPv6 Prefix ERO subtLV -->

    </section>

    <section title="Advertising Label Examples">
      <section title="Sample Topology">
	<t>
	  The following <xref target="sample-topology">topology</xref> and IP addresses shall be used throughout
	  the Label advertisment examples.
	</t>

        <figure anchor="sample-topology" title="Sample Topology">
          <artwork>

                    AS1                         :    AS 2
                                                :
                     :                          :
         Level 1     :     Level 2              :
                     :                          :
+-----+           +-----+-IP3--IP4--+-----+     :
| R1  +-IP1--IP2--+ R2  |           | R3  |     :
+--+--+           +--+--+-IP5--IP6--+--+--+-IP15-IP16-
   |                 |                 |        :     \
  IP3               IP7               IP13      :   +--+--+
   |                 |                 |        :   |  R7 |
  IP4               IP8               IP14      :   +--+--+
   |                 |                 |        :     /
+--+--+           +--+--+           +--+--+-IP17-IP18-
|  R4 +-IP19-IP20-+ R5  |-IP11-IP12-| R6  |     :
+-----+           +-----+           +-----+     :
                     :                          :
                     :                          :
                     :                          :
	  </artwork>
	</figure>

	<section title="Transport IP addresses and router-IDs">
	  <t><list style="symbols">
	    <t>R1: 192.168.1.1</t>
	    <t>R2: 192.168.1.2</t>
	    <t>R3: 192.168.1.3</t>
	    <t>R4: 192.168.1.4</t>
	    <t>R5: 192.168.1.5</t>
	    <t>R6: 192.168.1.6</t>
	    <t>R7: 192.168.1.7</t>
	  </list></t>	
	</section>

	<section title="Link IP addresses">
	  <t><list style="symbols">
	    <t>R1 to R2 link: 10.0.0.1, 10.0.0.2</t>
	    <t>R1 to R4 link: 10.0.0.3, 10.0.0.4</t>
	    <t>R2 to R3 link #1: 10.0.0.3, 10.0.0.4</t>
	    <t>R2 to R3 link #2: 10.0.0.5, 10.0.0.6</t>
	    <t>R2 to R5 link: 10.0.0.7, 10.0.0.8</t>
	    <t>R3 to R6 link: 10.0.0.13, 10.0.0.14</t>
	    <t>R3 to R7 link: 10.0.0.15, 10.0.0.16</t>
	    <t>R4 to R5 link: 10.0.0.19, 10.0.0.20</t>
	    <t>R5 to R6 link: 10.0.0.11, 10.0.0.12</t>
	    <t>R6 to R7 link: 10.0.0.17, 10.0.0.18</t>
	  </list></t>	
	</section>

      </section>

      <section title="Pointer to an adjacent Router">
	<t>If R1 would advertise a label &lt;N&gt; pointing to R2 it would encode as follows:</t>
		<t><list style="hangout">
	  <t>TLV 149: MPLS label N, Flags {}:
	  <list style="hangout">
	    <t>IPv4 Prefix ERO subTLV: 192.168.1.2/32, Loose</t>
	  </list></t>
	</list></t>	
      </section>

      <section title="Pointer to an adjacent Router using a specific link">
	<t>If R2 would advertise a label &lt;N&gt; pointing to R3, using the link #2 it would encode as follows</t>
	
	<t><list style="hangout">
	  <t>TLV 149: MPLS label &lt;N&gt;, Flags {}:
	  <list style="hangout">
	    <t>IPv4 Prefix ERO subTLV: 10.0.0.6/32, Strict</t>
	  </list></t>
	</list></t>	
      </section>

      <section title="Advertising a domain-wide Label">
	<t>If R1 would advertise a domain-wide label &lt;N&gt; pointing to self, PHP</t>
	<t><list style="hangout">
	  <t>TLV 149: MPLS label &lt;N&gt;, Flags {W, P}:
	  <list style="hangout">
	    <t>IPv4 Prefix ERO subTLV: 192.168.1.1/32, Strict</t>
	  </list></t>
	</list></t>	

	<t>If R2 would advertise a domain-wide label &lt;N&gt; for itself, UHP</t>
	<t><list style="hangout">
	  <t>TLV 149: MPLS label &lt;N&gt;, Flags {W}:
	  <list style="hangout">
	    <t>IPv4 Prefix ERO subTLV: 192.168.1.2/32, Strict</t>
	  </list></t>
	</list></t>	
      </section>

      <section title="Pointer to an RSVP LSP">
	<t>Consider a RSVP LSP name "R2-to-R6" traversing (R2 to R3 using link #1, R6):</t>
	<t>If R2 would advertise a label &lt;N&gt; to R3, using the link #2 it would encode as follows</t>
	
	<t><list style="hangout">
	  <t>TLV 149: MPLS label &lt;N&gt;, Flags {}:
	  <list style="hangout">
	    <t>IPv4 Prefix ERO subTLV: 10.0.0.4/32, Strict</t>
	    <t>IPv4 Prefix ERO subTLV: 192.168.1.6/32, Loose</t>
	  </list></t>
	</list></t>	
      </section>

      <section title="Pointer to an LDP LSP">
	<t>Consider a LDP LSP label  &lt;N&gt; pointing to FEC 172.16.0.0/12:</t>
	<t>If R2 would re-advertise the LDP FEC it would encode as follows</t>
	
	<t><list style="hangout">
	  <t>TLV 149: MPLS label &lt;N&gt;, Flags {}:
	  <list style="hangout">
	    <t>IPv4 Prefix ERO subTLV: 172.16.0.0/12, Loose</t>
	  </list></t>
	</list></t>	
      </section>

    </section>

    <section anchor="Acknowledgements" title="Acknowledgements">
      <t>Many thanks to Yakov Rehkter his useful comments.</t>
    </section>

    <section anchor="IANA" title="IANA Considerations">
      <t>This memo request one TLV and a two subTLVs for carrying the label value and its ERO.</t>
      <!--FIXME-->
    </section>

    <section anchor="Security" title="Security Considerations">
      <t> This document does not introduce any change in terms of IS-IS
      security. It simply proposes to flood MPLS label information via the IGP.
      All existing procedures to ensure message integrety do apply here.
      </t>
    </section>
  </middle>

  <!--  *****BACK MATTER ***** -->

  <back>

    <references title="Normative References">
      <?rfc include="http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml"?>
      <?rfc include="http://xml.resource.org/public/rfc/bibxml/reference.RFC.3107.xml"?>
      <?rfc include="http://xml.resource.org/public/rfc/bibxml/reference.RFC.3209.xml"?>
      <?rfc include="http://xml.resource.org/public/rfc/bibxml/reference.RFC.5036.xml"?>
      <?rfc include="http://xml.resource.org/public/rfc/bibxml/reference.RFC.5151.xml"?>
      <?rfc include="http://xml.resource.org/public/rfc/bibxml/reference.RFC.5302.xml"?>
      <?rfc include="http://xml.resource.org/public/rfc/bibxml/reference.RFC.5305.xml"?>
    </references>

    <references title="Informative References">
      <?rfc include="http://xml.resource.org/public/rfc/bibxml3/reference.I-D.draft-gredler-rtgwg-igp-label-advertisement-02.xml"?>
      <?rfc include="http://xml.resource.org/public/rfc/bibxml3/reference.I-D.draft-previdi-filsfils-isis-segment-routing-02.xml"?>
    </references>

  </back>
</rfc>
